<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGSIST | Killer Ag Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#08080c;--panel:#0d0d14;--card:#12121a;--hover:#181822;--border:#1e1e2a;--accent:#d4a942;--accent-dim:#9a7830;--green:#22c55e;--red:#ef4444;--text:#e2e2ed;--dim:#8a8aa5;--bright:#ffffff}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Space Grotesk',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:16px;line-height:1.5}
        
        /* KILLER TICKER - SEAMLESS & SLOWER FOR READING NEWS */
        .ticker-wrap{background:linear-gradient(90deg,var(--card) 0%,var(--panel) 50%,var(--card) 100%);border-bottom:2px solid var(--border);overflow:hidden;white-space:nowrap;padding:12px 0;position:relative}
        .ticker{display:inline-block;animation:scroll 120s linear infinite;padding-left:0; display: flex; align-items: center;}
        .ticker:hover{animation-play-state:paused}
        
        .ticker-item{font-family:'JetBrains Mono',monospace;font-size:.95rem;color:var(--bright);padding:0 24px;font-weight:500;display:inline-flex;align-items:center;border-right:1px solid #222}
        .ticker-item .label{color:var(--dim);font-size:.8rem;margin-right:8px}
        .ticker-item .up{color:var(--green);font-weight:700;margin-left:6px}
        .ticker-item .down{color:var(--red);font-weight:700;margin-left:6px}
        
        /* NEWS HEADLINE IN TICKER */
        .ticker-news { color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .ticker-news .source { background: var(--accent-dim); color: #000; padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; margin-right: 8px; }
        
        @keyframes scroll{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
        
        /* LAYOUT */
        header{background:var(--panel);border-bottom:1px solid var(--border);padding:14px 24px;position:sticky;top:0;z-index:100}
        .header-inner{max-width:1800px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px}
        
        .logo{text-decoration:none;display:flex;align-items:center;gap:8px}
        .logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--accent) 0%,#b8912e 100%);display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:bold;color:var(--bg);clip-path:polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%)}
        .logo-text{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,var(--accent) 0%,#f0d080 50%,var(--accent) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:3px}
        
        .nav{display:flex;gap:6px}
        .nav a{font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--dim);text-decoration:none;padding:12px 16px;border:1px solid transparent;transition:.2s;font-weight:500}
        .nav a:hover,.nav a.active{color:var(--bright);border-color:var(--accent);background:var(--card)}
        .live-badge{display:flex;align-items:center;gap:8px;font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--dim)}
        .live-dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:blink 2s infinite;box-shadow:0 0 8px var(--green)}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        
        main{max-width:1800px;margin:0 auto;padding:24px}
        .tab{display:none}.tab.active{display:block}
        .grid-main{display:grid;grid-template-columns:1fr 380px;gap:24px}
        
        /* PANELS */
        .panel{background:var(--panel);border:1px solid var(--border);border-radius:4px;overflow:hidden}
        .panel-head{background:var(--card);padding:14px 18px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .panel-head h2{font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--accent);letter-spacing:2px;font-weight:600}
        .panel-body{padding:18px}
        
        .section-label{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--accent);letter-spacing:2px;margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border);font-weight:600}
        
        /* CARDS */
        .market-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
        .market-card{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:4px;transition:.2s}
        .market-card:hover{border-color:var(--accent-dim)}
        .market-card .name{font-size:1rem;color:var(--bright);margin-bottom:2px;font-weight:600}
        .market-card .symbol{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--dim)}
        .market-card .contract{font-family:'JetBrains Mono',monospace;font-size:.75rem;color:var(--accent);margin-top:2px}
        .market-card .price{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--bright);margin:10px 0}
        .market-card .change{font-family:'JetBrains Mono',monospace;font-size:.9rem;font-weight:600}
        .market-card .change.up{color:var(--green)}.market-card .change.down{color:var(--red)}
        .market-card .unit{font-size:.75rem;color:var(--dim)}

        /* 52 WK RANGE */
        .range-container { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--hover); }
        .range-bar { height: 4px; background: var(--hover); border-radius: 2px; position: relative; margin-bottom: 6px; }
        .range-cursor { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; position: absolute; top: 50%; transform: translate(-50%, -50%); border: 1px solid var(--card); z-index:2; }
        .range-labels { display: flex; justify-content: space-between; font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--dim); }

        /* FEED TABS */
        .feed-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--card)}
        .feed-tab{flex:1;padding:12px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--dim);cursor:pointer;transition:.2s;border-bottom:2px solid transparent}
        .feed-tab:hover{background:var(--hover);color:var(--text)}
        .feed-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--panel)}
        
        .feed-content{display:none;max-height:600px;overflow-y:auto}
        .feed-content.active{display:block}
        
        /* NEWS WIRE ITEMS */
        .news-item{padding:14px;border-bottom:1px solid var(--border);display:block;text-decoration:none;transition:.2s}
        .news-item:hover{background:var(--hover);padding-left:18px}
        .news-item .meta{display:flex;gap:8px;font-size:.7rem;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
        .news-item .tag{color:var(--bg);background:var(--dim);padding:2px 6px;border-radius:2px;font-weight:600}
        .news-item .tag.usda{background:#2a4f87;color:#fff}
        .news-item .tag.agweb{background:#d4a942;color:#000}
        .news-item h4{color:var(--text);font-size:.95rem;line-height:1.4;font-weight:500}
        .news-item:visited h4{color:var(--dim)}

        /* TOOLS & WEATHER */
        .tool-link{display:flex;align-items:center;gap:14px;padding:16px 14px;border-bottom:1px solid var(--border);text-decoration:none;color:var(--text);transition:.2s;cursor:pointer}
        .tool-link:hover{background:var(--hover);padding-left:18px}
        .tool-icon{width:40px;height:40px;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;border-radius:4px}
        .tool-info h3{font-size:1rem;font-weight:600;color:var(--bright)}.tool-info p{font-size:.85rem;color:var(--dim)}
        
        .weather-grid{display:grid;grid-template-columns:1.5fr 1fr;gap:16px;margin-top:12px}
        .radar{background:var(--card);border:1px solid var(--border);height:420px;overflow:hidden;border-radius:4px}
        .radar iframe{width:100%;height:100%;border:none}
        .forecast-day{background:var(--card);border:1px solid var(--border);padding:12px 14px;display:grid;grid-template-columns:55px 1fr auto;align-items:center;gap:14px;border-radius:4px;margin-bottom:8px}
        .forecast-day .day{font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--accent);font-weight:600}
        .forecast-day .temp strong{color:var(--bright)}

        /* RESPONSIVE */
        @media(max-width:1200px){.grid-main{grid-template-columns:1fr}}
        @media(max-width:900px){.weather-grid{grid-template-columns:1fr}}
        @media(max-width:600px){
            .header-inner{flex-direction:column;text-align:center}
            .nav{flex-wrap:wrap;justify-content:center}
            .market-grid{grid-template-columns:1fr 1fr}
        }
    </style>
</head>
<body>
    <div class="ticker-wrap">
        <div class="ticker" id="news-ticker">
            <span class="ticker-item">Loading data...</span>
        </div>
    </div>

    <header>
        <div class="header-inner">
            <a href="/" class="logo">
                <div class="logo-icon">AG</div>
                <span class="logo-text">AGSIST</span>
            </a>
            <nav class="nav">
                <a href="#" class="active" data-tab="dashboard">DASHBOARD</a>
                <a href="#" data-tab="calculator">CALCULATOR</a>
                <a href="#" data-tab="offices">USDA OFFICES</a>
                <a href="#" data-tab="resources">RESOURCES</a>
            </nav>
            <div class="live-badge"><span class="live-dot"></span><span id="update-time">Loading...</span></div>
        </div>
    </header>

    <main>
        <div id="dashboard" class="tab active">
            <div class="grid-main">
                <div class="panel">
                    <div class="panel-head"><h2>LIVE MARKETS</h2><span>Auto-updated 24/7</span></div>
                    <div class="panel-body">
                        <div class="section-label">GRAINS</div>
                        <div class="market-grid" id="grains-grid"><div class="loading">Loading...</div></div>
                        
                        <div class="section-label">LIVESTOCK & DAIRY</div>
                        <div class="market-grid" id="livestock-grid"><div class="loading">Loading...</div></div>
                        
                        <div class="section-label">INDICES & METALS</div>
                        <div class="market-grid" id="metals-grid"><div class="loading">Loading...</div></div>
                        
                        <div class="section-label">CRYPTO</div>
                        <div class="market-grid" id="crypto-grid"><div class="loading">Loading...</div></div>
                        
                        <div class="section-label" id="weather-label">WEATHER ‚Äî <span id="location-name">DETECTING...</span></div>
                        <div class="weather-grid">
                            <div class="radar" id="radar-wrap"><iframe id="radar-iframe" src="https://embed.windy.com/embed2.html?lat=45.4&lon=-91.8&detailLat=45.4&detailLon=-91.8&width=650&height=450&zoom=7&level=surface&overlay=radar&product=radar&menu=&message=true&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=true&metricWind=mph&metricTemp=%C2%B0F&radarRange=-1" title="Radar"></iframe></div>
                            <div class="forecast" id="forecast"><div class="loading">Loading forecast...</div></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="panel">
                        <div class="feed-tabs">
                            <div class="feed-tab active" onclick="switchFeed('social')">TWITTER</div>
                            <div class="feed-tab" onclick="switchFeed('news')">NEWS WIRE</div>
                        </div>
                        
                        <div id="feed-social" class="feed-content active" style="padding:0">
                            <div style="border-bottom:1px solid var(--border); padding:10px;">
                                <a class="twitter-timeline" data-height="400" data-theme="dark" data-chrome="noheader nofooter transparent" href="https://twitter.com/USDA?ref_src=twsrc%5Etfw">Tweets by USDA</a>
                            </div>
                            <div style="padding:10px;">
                                <a class="twitter-timeline" data-height="400" data-theme="dark" data-chrome="noheader nofooter transparent" href="https://twitter.com/AgWebEditor?ref_src=twsrc%5Etfw">Tweets by AgWeb</a>
                            </div>
                            <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                        </div>
                        
                        <div id="feed-news" class="feed-content">
                            <div id="news-wire-list" style="padding-bottom:20px">
                                <div class="loading" style="padding:20px">Loading headlines...</div>
                            </div>
                        </div>
                    </div>

                    <div class="panel" style="margin-top:20px">
                        <div class="panel-head"><h2>QUICK TOOLS</h2></div>
                        <div class="panel-body" style="padding:0">
                            <div class="tool-link" data-tab="calculator"><div class="tool-icon">üåæ</div><div class="tool-info"><h3>Grain Bin Calculator</h3><p>Bushels, weight, shrinkage</p></div></div>
                            <div class="tool-link" data-tab="offices"><div class="tool-icon">üèõÔ∏è</div><div class="tool-info"><h3>Find USDA Office</h3><p>FSA / NRCS by county</p></div></div>
                            <a href="https://webapp.rma.usda.gov/apps/actuarialinformationbrowser/" target="_blank" rel="noopener" class="tool-link"><div class="tool-icon">üìä</div><div class="tool-info"><h3>RMA Actuarial Browser</h3><p>Crop insurance rates</p></div></a>
                            <a href="https://farmers1st.com" target="_blank" rel="noopener" class="tool-link"><div class="tool-icon">üîç</div><div class="tool-info"><h3>Find Insurance Agent</h3><p>Farmers First Agri Service</p></div></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="calculator" class="tab"> </div>
        <div id="offices" class="tab"> </div>
        <div id="resources" class="tab"> </div>

    </main>

    <script>
    // ============ TAB UI LOGIC ============
    function switchFeed(type) {
        document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.feed-content').forEach(c => c.classList.remove('active'));
        
        if(type === 'social') {
            document.querySelectorAll('.feed-tab')[0].classList.add('active');
            document.getElementById('feed-social').classList.add('active');
        } else {
            document.querySelectorAll('.feed-tab')[1].classList.add('active');
            document.getElementById('feed-news').classList.add('active');
        }
    }

    document.querySelectorAll('[data-tab]').forEach(el => {
        el.addEventListener('click', e => {
            if(el.classList.contains('feed-tab')) return; // Ignore feed tabs
            e.preventDefault();
            const tabId = el.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
            const target = document.getElementById(tabId);
            if(target) target.classList.add('active');
            const navLink = document.querySelector(`.nav a[data-tab="${tabId}"]`);
            if(navLink) navLink.classList.add('active');
        });
    });

    // ============ DATA LOADING ============
    async function loadData() {
        try {
            // Fetch the single JSON file that now contains MARKETS + NEWS
            const res = await fetch('data/markets.json');
            const data = await res.json();
            
            // 1. Update Time
            const updated = new Date(data.updated);
            document.getElementById('update-time').textContent = `Updated ${updated.toLocaleTimeString()}`;
            
            // 2. Render Markets
            const m = data.markets;
            renderMarketSection('grains-grid', [m.grains?.corn, m.grains?.soybeans, m.grains?.wheat]);
            renderMarketSection('livestock-grid', [m.livestock?.cattle, m.livestock?.feeder, m.livestock?.milk]);
            renderMarketSection('metals-grid', [m.indices?.sp500, m.indices?.dow, m.metals?.gold, m.metals?.silver]);
            renderMarketSection('crypto-grid', [m.crypto?.bitcoin, m.crypto?.ethereum, m.crypto?.kaspa, m.crypto?.xrp]);
            
            // 3. Render News Wire (Sidebar)
            renderNewsWire(data.news || []);
            
            // 4. Update Killer Ticker (Markets + News Mixed)
            updateKillerTicker(m, data.news || []);
            
        } catch (err) {
            console.error('Failed to load data:', err);
        }
    }
    
    function renderMarketSection(gridId, items) {
        const grid = document.getElementById(gridId);
        if (!grid) return;
        items = items.filter(Boolean);
        
        grid.innerHTML = items.map(item => {
            const changeClass = item.change >= 0 ? 'up' : 'down';
            const sign = item.change >= 0 ? '+' : '';
            const price = item.unit === '$' 
                ? item.price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})
                : item.price.toFixed(2);
                
            // Contract + Range Logic
            const contractHtml = item.contract && item.contract !== 'Spot' ? `<div class="contract">${item.contract}</div>` : '';
            
            let rangeHtml = '';
            if (item.low52 && item.high52 && item.high52 > item.low52) {
                let pct = ((item.price - item.low52) / (item.high52 - item.low52)) * 100;
                pct = Math.max(0, Math.min(100, pct));
                const formatLabel = (val) => item.unit === '$' ? val.toLocaleString(undefined,{maximumFractionDigits:0}) : val.toFixed(2);
                rangeHtml = `
                    <div class="range-container">
                        <div class="range-bar"><div class="range-cursor" style="left: ${pct}%"></div></div>
                        <div class="range-labels"><span>L:${formatLabel(item.low52)}</span><span>H:${formatLabel(item.high52)}</span></div>
                    </div>`;
            }

            return `
                <div class="market-card">
                    <div class="name">${item.name}</div>
                    <div class="symbol">${item.symbol}</div>
                    ${contractHtml}
                    <div class="price">${price}</div>
                    <div class="change ${changeClass}">${sign}${item.change.toFixed(2)} (${sign}${item.changePct.toFixed(2)}%)</div>
                    <div class="unit">${item.unit}</div>
                    ${rangeHtml}
                </div>`;
        }).join('');
    }
    
    function renderNewsWire(newsItems) {
        const container = document.getElementById('news-wire-list');
        if(!container) return;
        
        if(newsItems.length === 0) {
            container.innerHTML = '<div style="padding:20px;color:var(--dim)">No news available</div>';
            return;
        }
        
        container.innerHTML = newsItems.map(item => {
            const tagClass = item.source.toLowerCase().includes('usda') ? 'usda' : 'agweb';
            return `
                <a href="${item.link}" target="_blank" class="news-item">
                    <div class="meta"><span class="tag ${tagClass}">${item.source}</span></div>
                    <h4>${item.title}</h4>
                </a>`;
        }).join('');
    }
    
    function updateKillerTicker(markets, news) {
        // Create a flat list of market items
        const marketItems = [];
        // Helper to add market item
        const addM = (label, d) => {
            if(!d) return;
            const cls = d.change >= 0 ? 'up' : 'down';
            const val = d.unit === '$' ? d.price.toLocaleString(undefined, {maximumFractionDigits:2}) : d.price.toFixed(2);
            marketItems.push(`<span class="ticker-item"><span class="label">${label}</span>${val}<span class="${cls}">${d.change >= 0 ? '+' : ''}${d.changePct.toFixed(2)}%</span></span>`);
        };
        
        addM('CORN', markets.grains?.corn);
        addM('BEANS', markets.grains?.soybeans);
        addM('WHEAT', markets.grains?.wheat);
        addM('CATTLE', markets.livestock?.cattle);
        addM('MILK', markets.livestock?.milk);
        addM('S&P', markets.indices?.sp500);
        addM('GOLD', markets.metals?.gold);
        
        // Interleave News!
        let finalHtml = '';
        const maxlen = Math.max(marketItems.length, news.length);
        
        for(let i=0; i<maxlen; i++) {
            // Add Market Item if available
            if(marketItems[i % marketItems.length]) {
                finalHtml += marketItems[i % marketItems.length];
            }
            // Add News Item if available
            if(news[i]) {
                finalHtml += `<span class="ticker-item ticker-news"><span class="source">${news[i].source}</span> ${news[i].title}</span>`;
            }
        }
        
        // Duplicate for seamless loop
        document.getElementById('news-ticker').innerHTML = finalHtml + finalHtml;
    }

    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        loadForecast(); // Assuming loadForecast and calcBin are still present in your file or I need to add them back if you lost them.
        // Assuming calcBin() and findOffice() are kept from previous version
        if(window.calcBin) calcBin();
        if(window.getLocation) getLocation();
        
        setInterval(loadData, 60 * 1000); // Check for new JSON every minute
    });
    </script>
</body>
</html>
