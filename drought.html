<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0a0a0c">
    <title>Drought Monitor - Live Conditions | AGSIST</title>
    <meta name="keywords" content="drought monitor, USDM, drought conditions, drought severity, agricultural drought, drought aid">
    <meta name="description" content="Real-time US Drought Monitor data. State drought percentages, D0-D4 classifications, agricultural impacts, and weekly updates from USDM.">
    <link rel="canonical" href="https://agsist.com/drought.html">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Drought Monitor & Ag Impact | AGSIST">
    <meta property="og:description" content="Live US Drought Monitor data with agricultural impact analysis and USDA aid programs.">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Drought Monitor & Ag Impact | AGSIST">
    <meta name="twitter:description" content="Live US Drought Monitor data with agricultural impact analysis and USDA aid programs.">
    <meta property="og:url" content="https://agsist.com/drought.html">
    <meta property="og:type" content="website">
    <link rel="icon" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/components/shared.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6KXCTD5Z9H"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-6KXCTD5Z9H');</script>
    <style>
        :root { --d0: #ffff00; --d1: #fcd37f; --d2: #ffaa00; --d3: #e60000; --d4: #730000; --none: #ffffff; }
        main { max-width: 1300px; margin: 0 auto; padding: 16px; }
        .breadcrumb { font-size: 0.85rem; color: var(--dim); margin-bottom: 16px; }
        .breadcrumb a { color: var(--accent); text-decoration: none; }

        .hero { background: linear-gradient(135deg, #4a2800 0%, #7a4400 100%); border: 2px solid var(--accent); border-radius: 12px; padding: 28px; text-align: center; margin-bottom: 20px; }
        .hero h1 { color: #fff; font-size: 1.5rem; margin: 0 0 8px; }
        .hero p { color: rgba(255,255,255,0.85); font-size: 0.9rem; margin: 0; }

        .state-bar { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 14px 18px; margin-bottom: 20px; display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
        .state-bar label { color: var(--dim); font-size: 0.85rem; }
        .state-bar select { padding: 10px 14px; font-family: inherit; font-size: 0.9rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); }
        .detect-btn { padding: 10px 16px; background: var(--accent); color: #000; border: none; border-radius: 6px; font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer; }

        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; }
        .panel-head { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .panel-head h2 { font-size: 1rem; color: var(--accent); margin: 0; }
        .panel-head .badge { font-size: 0.75rem; padding: 4px 8px; background: var(--accent); color: #000; border-radius: 12px; font-weight: 600; }
        .panel-body { padding: 18px; }

        /* Map */
        .map-wrap { background: #fff; border-radius: 6px; overflow: hidden; text-align: center; padding: 8px; margin-bottom: 12px; }
        .map-wrap img { max-width: 100%; height: auto; }
        .map-label { font-size: 0.7rem; color: var(--dim); text-align: center; margin-top: 6px; }

        /* Stats cards */
        .drought-stats { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 16px; }
        .d-stat { border-radius: 8px; padding: 14px 8px; text-align: center; position: relative; overflow: hidden; }
        .d-stat::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .d-stat.none { background: rgba(255,255,255,0.05); }
        .d-stat.none::before { background: var(--none); }
        .d-stat.d0 { background: rgba(255,255,0,0.08); }
        .d-stat.d0::before { background: var(--d0); }
        .d-stat.d1 { background: rgba(252,211,127,0.1); }
        .d-stat.d1::before { background: var(--d1); }
        .d-stat.d2 { background: rgba(255,170,0,0.1); }
        .d-stat.d2::before { background: var(--d2); }
        .d-stat.d3 { background: rgba(230,0,0,0.1); }
        .d-stat.d3::before { background: var(--d3); }
        .d-stat.d4 { background: rgba(115,0,0,0.12); }
        .d-stat.d4::before { background: var(--d4); }
        .d-stat .pct { font-size: 1.5rem; font-weight: 700; color: var(--text); }
        .d-stat .lbl { font-size: 0.75rem; color: var(--dim); margin-top: 4px; }
        .d-stat .loading { color: var(--dim); font-size: 1rem; }

        /* Stacked bar */
        .stacked-bar { height: 32px; border-radius: 6px; overflow: hidden; display: flex; margin-bottom: 6px; background: var(--bg); }
        .stacked-bar .seg { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: #000; transition: width 0.5s; min-width: 0; }
        .stacked-bar .seg.none { background: #e8e8e8; }
        .stacked-bar .seg.d0 { background: var(--d0); }
        .stacked-bar .seg.d1 { background: var(--d1); }
        .stacked-bar .seg.d2 { background: var(--d2); }
        .stacked-bar .seg.d3 { background: var(--d3); color: #fff; }
        .stacked-bar .seg.d4 { background: var(--d4); color: #fff; }
        .bar-label { font-size: 0.75rem; color: var(--dim); margin-bottom: 6px; }
        .bar-legend { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
        .bar-legend span { font-size: 0.7rem; display: flex; align-items: center; gap: 4px; color: var(--dim); }
        .bar-legend .dot { width: 10px; height: 10px; border-radius: 2px; }

        /* Impact table */
        .impact-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .impact-table th { background: var(--bg); padding: 10px; text-align: left; font-size: 0.7rem; color: var(--dim); text-transform: uppercase; border-bottom: 2px solid var(--border); }
        .impact-table td { padding: 10px; border-bottom: 1px solid var(--border); vertical-align: top; }
        .impact-table tr:hover { background: var(--bg); }
        .impact-level { display: inline-block; padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 0.75rem; color: #000; }

        /* Compare */
        .compare-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .compare-card { background: var(--bg); border-radius: 8px; padding: 14px; }
        .compare-card h4 { font-size: 0.85rem; color: var(--text); margin: 0 0 8px 0; }
        .compare-card .mini-bar { height: 16px; border-radius: 4px; overflow: hidden; display: flex; background: var(--card); }
        .compare-card .mini-bar .seg { height: 100%; }
        .compare-card .summary { font-size: 0.7rem; color: var(--dim); margin-top: 6px; }

        .info-box { background: var(--bg); border-left: 4px solid var(--accent); padding: 14px 18px; border-radius: 0 8px 8px 0; margin: 16px 0; font-size: 0.85rem; color: var(--dim); }
        .info-box strong { color: var(--text); }
        .info-box a { color: var(--accent); }
        .info-box.warning { border-color: #e60000; }

        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .ext-link { display: block; padding: 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; text-decoration: none; }
        .ext-link:hover { border-color: var(--accent); }
        .ext-link strong { display: block; color: var(--text); font-size: 0.85rem; margin-bottom: 4px; }
        .ext-link span { color: var(--dim); font-size: 0.75rem; }

        .api-status { font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; }
        .api-status.live { background: rgba(34,197,94,0.2); color: #22c55e; }
        .api-status.offline { background: rgba(239,68,68,0.2); color: #ef4444; }

        @media (max-width: 768px) {
            main { padding: 10px; }
            .two-col { grid-template-columns: 1fr; }
            .drought-stats { grid-template-columns: repeat(3, 1fr); }
            .state-bar { flex-direction: column; align-items: stretch; }
        }
    </style>

    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Drought Monitor Dashboard",
        "description": "Live USDM drought data with agricultural impact analysis by state",
        "url": "https://agsist.com/drought.html",
        "applicationCategory": "Agriculture",
        "operatingSystem": "Web Browser",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "USD"}
    }
    </script>
</head>
<body>
    <div id="header"></div>
    <main id="main-content">
        <nav class="breadcrumb"><a href="/">Home</a> ‚Üí <a href="/tools.html">Tools</a> ‚Üí Drought Monitor</nav>

        <div class="hero">
            <h1>üèúÔ∏è US Drought Monitor</h1>
            <p>Live drought conditions across the United States ‚Ä¢ Updated every Thursday at 8:30 AM ET</p>
        </div>

        <div class="state-bar">
            <label>Your State:</label>
            <select id="stateSelect" aria-label="Select state"></select>
            <button class="detect-btn" onclick="detectMyLocation()">üìç Detect</button>
            <span id="apiStatus" class="api-status" style="margin-left: auto;">Connecting...</span>
        </div>

        <!-- State Dashboard -->
        <div class="panel">
            <div class="panel-head">
                <h2 id="stateTitle">üìä Wisconsin Drought Status</h2>
                <span class="badge" id="dateLabel">Loading...</span>
            </div>
            <div class="panel-body">
                <div class="drought-stats" id="droughtStats">
                    <div class="d-stat none"><div class="pct loading">...</div><div class="lbl">None</div></div>
                    <div class="d-stat d0"><div class="pct loading">...</div><div class="lbl">D0 Abnormal</div></div>
                    <div class="d-stat d1"><div class="pct loading">...</div><div class="lbl">D1 Moderate</div></div>
                    <div class="d-stat d2"><div class="pct loading">...</div><div class="lbl">D2 Severe</div></div>
                    <div class="d-stat d3"><div class="pct loading">...</div><div class="lbl">D3 Extreme</div></div>
                    <div class="d-stat d4"><div class="pct loading">...</div><div class="lbl">D4 Exception.</div></div>
                </div>

                <div class="bar-label">Area in Drought:</div>
                <div class="stacked-bar" id="mainBar"></div>
                <div class="bar-legend">
                    <span><div class="dot" style="background:#e8e8e8"></div> None</span>
                    <span><div class="dot" style="background:var(--d0)"></div> D0</span>
                    <span><div class="dot" style="background:var(--d1)"></div> D1</span>
                    <span><div class="dot" style="background:var(--d2)"></div> D2</span>
                    <span><div class="dot" style="background:var(--d3)"></div> D3</span>
                    <span><div class="dot" style="background:var(--d4)"></div> D4</span>
                </div>
            </div>
        </div>

        <div class="two-col">
            <!-- Map -->
            <div class="panel">
                <div class="panel-head"><h2>üó∫Ô∏è National Drought Map</h2></div>
                <div class="panel-body">
                    <div class="map-wrap">
                        <img src="https://droughtmonitor.unl.edu/data/png/current/current_usdm.png" alt="Current US Drought Monitor Map" id="droughtMap" loading="lazy">
                    </div>
                    <div class="map-label">Source: <a href="https://droughtmonitor.unl.edu/" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">US Drought Monitor</a> (NOAA/<span class="tip" data-tip="United States Department of Agriculture">USDA</span>/UNL)</div>
                </div>
            </div>

            <!-- Neighbor Compare -->
            <div class="panel">
                <div class="panel-head"><h2>üèòÔ∏è Regional Comparison</h2></div>
                <div class="panel-body">
                    <div class="compare-grid" id="compareGrid">
                        <div style="color:var(--dim);text-align:center;padding:20px;">Loading regional data...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agricultural Impacts -->
        <div class="panel">
            <div class="panel-head"><h2>üåæ Agricultural Impacts by Drought Level</h2></div>
            <div class="panel-body">
                <div style="overflow-x:auto;">
                    <table class="impact-table">
                        <thead><tr><th>Level</th><th>Name</th><th>Crop Impacts</th><th>Livestock Impacts</th><th>Possible Actions</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><span class="impact-level" style="background:var(--d0);">D0</span></td>
                                <td>Abnormally Dry</td>
                                <td>Short-term dryness slowing planting or growth. Top soil moisture declining.</td>
                                <td>Pasture conditions declining. Supplemental feeding may start early.</td>
                                <td>Monitor soil moisture. Delay tillage to conserve moisture.</td>
                            </tr>
                            <tr>
                                <td><span class="impact-level" style="background:var(--d1);">D1</span></td>
                                <td>Moderate</td>
                                <td>Crop stress visible. Yields expected below normal. Dryland crops suffering.</td>
                                <td>Hay supplies tightening. Stock ponds declining. Early weaning considered.</td>
                                <td>Apply for <span class="tip" data-tip="Farm Service Agency ‚Äî USDA office for farm programs, loans, and payments">FSA</span> emergency loans. Check crop insurance deadlines.</td>
                            </tr>
                            <tr>
                                <td><span class="impact-level" style="background:var(--d2);">D2</span></td>
                                <td>Severe</td>
                                <td>Significant crop losses likely. Irrigation demand high. Corn pollination at risk.</td>
                                <td>Feed costs rising sharply. Herd reduction begins. Water hauling needed.</td>
                                <td>File prevented planting claims. Contact <span class="tip" data-tip="Farm Service Agency ‚Äî USDA office for farm programs, loans, and payments">FSA</span> for Emergency Conservation Program.</td>
                            </tr>
                            <tr>
                                <td><span class="impact-level" style="background:var(--d3);color:#fff;">D3</span></td>
                                <td>Extreme</td>
                                <td>Widespread crop failure. Irrigation restrictions possible. No-till considered permanent.</td>
                                <td>Major destocking. Emergency feed assistance needed. Water emergencies.</td>
                                <td><span class="tip" data-tip="United States Department of Agriculture">USDA</span> disaster designation likely. Apply for LFP, ELAP, TAP programs.</td>
                            </tr>
                            <tr>
                                <td><span class="impact-level" style="background:var(--d4);color:#fff;">D4</span></td>
                                <td>Exceptional</td>
                                <td>Near-total crop loss. Irrigation curtailed. Multi-year impacts to soil health.</td>
                                <td>Catastrophic herd liquidation. No grazing available. Well failures common.</td>
                                <td>Federal disaster declaration. All USDA emergency programs activated.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- USDA Drought Aid Programs -->
        <div class="panel">
            <div class="panel-head"><h2>üèõÔ∏è USDA Drought Assistance Programs</h2></div>
            <div class="panel-body">
                <div style="overflow-x:auto;">
                    <table class="impact-table">
                        <thead><tr><th>Program</th><th>Covers</th><th>Trigger</th><th>Link</th></tr></thead>
                        <tbody>
                            <tr><td><strong>LFP</strong></td><td>Livestock Forage Disaster</td><td>D2+ for 8 weeks on grazing land</td><td><a href="https://www.fsa.usda.gov/programs-and-services/disaster-assistance-program/livestock-forage/index" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Apply ‚Üí</a></td></tr>
                            <tr><td><strong>ELAP</strong></td><td>Emergency Livestock Assistance</td><td>Livestock losses from drought</td><td><a href="https://www.fsa.usda.gov/programs-and-services/disaster-assistance-program/emergency-assist-for-livestock-background/index" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Apply ‚Üí</a></td></tr>
                            <tr><td><strong>ECP</strong></td><td>Emergency Conservation</td><td>Fence, water facility repair</td><td><a href="https://www.fsa.usda.gov/programs-and-services/conservation-programs/emergency-conservation/index" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Apply ‚Üí</a></td></tr>
                            <tr><td><strong>EM Loans</strong></td><td>Emergency Farm Loans</td><td>Disaster designation by county</td><td><a href="https://www.fsa.usda.gov/programs-and-services/farm-loan-programs/emergency-farm-loans/index" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Apply ‚Üí</a></td></tr>
                            <tr><td><strong><span class="tip" data-tip="Conservation Reserve Program ‚Äî annual rental payments for retiring land">CRP</span> Haying</strong></td><td><span class="tip" data-tip="Conservation Reserve Program ‚Äî annual rental payments for retiring land">CRP</span> emergency haying/grazing</td><td>D2+ in county</td><td><a href="https://www.fsa.usda.gov/programs-and-services/conservation-programs/conservation-reserve-program/index" target="_blank" rel="noopener noreferrer" style="color:var(--accent);">Info ‚Üí</a></td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="info-box warning" style="margin-top:16px;">
                    <strong>‚ö†Ô∏è Act Early:</strong> Most USDA drought programs have filing deadlines. Contact your <a href="/offices.html">local FSA office</a> as soon as drought impacts begin ‚Äî don't wait for conditions to worsen.
                </div>
            </div>
        </div>

        <!-- External Links -->
        <div class="panel">
            <div class="panel-head"><h2>üîó Official Drought Resources</h2></div>
            <div class="panel-body">
                <div class="links-grid">
                    <a href="https://droughtmonitor.unl.edu/" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>US Drought Monitor</strong><span>Official weekly maps & data</span></a>
                    <a href="https://droughtmonitor.unl.edu/DmData/DataDownload/ComprehensiveStatistics.aspx" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>USDM Data Download</strong><span>CSV/Excel statistics</span></a>
                    <a href="https://www.drought.gov/" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>Drought.gov</strong><span>Forecasts & planning tools</span></a>
                    <a href="https://www.cpc.ncep.noaa.gov/products/expert_assessment/sdo_summary.php" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>CPC Drought Outlook</strong><span>Seasonal forecast</span></a>
                    <a href="https://www.fsa.usda.gov/programs-and-services/disaster-assistance-program/index" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>FSA Disaster Programs</strong><span>Federal aid for farmers</span></a>
                    <a href="https://nassgeodata.gmu.edu/CropScape/" target="_blank" rel="noopener noreferrer" class="ext-link"><strong>CropScape</strong><span>Crop land cover maps</span></a>
                </div>
            </div>
        </div>

        <div class="info-box">
            <strong>üìã About:</strong> The US Drought Monitor is produced weekly through NOAA, USDA, and the University of Nebraska-Lincoln. Maps release every Thursday at 8:30 AM ET based on data through the prior Tuesday. Categories range from D0 (Abnormally Dry) to D4 (Exceptional Drought).
        </div>
    </main>

    <div id="footer"></div>
    <script src="/components/load-components.js"></script>
    <script src="/components/geolocation.js"></script>
    <script>
        let currentState = 'WI';

        const stateNeighbors = {
            WI: ['MN','IA','IL','MI'], MN: ['WI','IA','ND','SD'], IA: ['MN','WI','IL','MO','NE','SD'],
            IL: ['WI','IA','IN','MO'], IN: ['IL','OH','MI'], OH: ['IN','MI','PA'],
            MI: ['WI','IN','OH'], ND: ['MN','SD','MT'], SD: ['ND','MN','IA','NE'],
            NE: ['SD','IA','KS','MO'], KS: ['NE','MO'], MO: ['IA','IL','KS','NE'],
            TX: ['OK','NM'], CA: ['OR','NV','AZ'], NY: ['PA','VT','CT','NJ'], PA: ['NY','OH','NJ']
        };

        const allStates = [
            ['AL','Alabama'],['AK','Alaska'],['AZ','Arizona'],['AR','Arkansas'],['CA','California'],
            ['CO','Colorado'],['CT','Connecticut'],['DE','Delaware'],['FL','Florida'],['GA','Georgia'],
            ['HI','Hawaii'],['ID','Idaho'],['IL','Illinois'],['IN','Indiana'],['IA','Iowa'],
            ['KS','Kansas'],['KY','Kentucky'],['LA','Louisiana'],['ME','Maine'],['MD','Maryland'],
            ['MA','Massachusetts'],['MI','Michigan'],['MN','Minnesota'],['MS','Mississippi'],['MO','Missouri'],
            ['MT','Montana'],['NE','Nebraska'],['NV','Nevada'],['NH','New Hampshire'],['NJ','New Jersey'],
            ['NM','New Mexico'],['NY','New York'],['NC','North Carolina'],['ND','North Dakota'],['OH','Ohio'],
            ['OK','Oklahoma'],['OR','Oregon'],['PA','Pennsylvania'],['RI','Rhode Island'],['SC','South Carolina'],
            ['SD','South Dakota'],['TN','Tennessee'],['TX','Texas'],['UT','Utah'],['VT','Vermont'],
            ['VA','Virginia'],['WA','Washington'],['WV','West Virginia'],['WI','Wisconsin'],['WY','Wyoming']
        ];

        // Store fetched data
        let droughtCache = {};

        function populateStates() {
            const sel = document.getElementById('stateSelect');
            sel.innerHTML = allStates.map(([a, n]) => `<option value="${a}">${n}</option>`).join('');
        }

        async function fetchDroughtData(stateAbbr) {
            if (droughtCache[stateAbbr]) return droughtCache[stateAbbr];

            try {
                // USDM API - fetch most recent data
                const end = new Date().toISOString().split('T')[0];
                const start = new Date(Date.now() - 30 * 86400000).toISOString().split('T')[0];
                const url = `https://usdmdataservices.unl.edu/api/StateStatistics/GetDroughtSeverityStatisticsByAreaPercent?aoi=${stateAbbr}&startdate=${start}&enddate=${end}&statisticsType=1`;

                const resp = await fetch(url);
                if (!resp.ok) throw new Error('API error');
                const data = await resp.json();

                if (data && data.length > 0) {
                    // Get most recent entry
                    const latest = data[data.length - 1];
                    const result = {
                        date: latest.MapDate || latest.mapDate,
                        none: parseFloat(latest.None || latest.none || 0),
                        d0: parseFloat(latest.D0 || latest.d0 || 0),
                        d1: parseFloat(latest.D1 || latest.d1 || 0),
                        d2: parseFloat(latest.D2 || latest.d2 || 0),
                        d3: parseFloat(latest.D3 || latest.d3 || 0),
                        d4: parseFloat(latest.D4 || latest.d4 || 0),
                        live: true
                    };
                    droughtCache[stateAbbr] = result;
                    return result;
                }
                throw new Error('No data');
            } catch (err) {
                // API failed - return null so we can show fallback
                console.log('USDM API unavailable for', stateAbbr, err.message);
                return null;
            }
        }

        function renderStats(data) {
            const statsEl = document.getElementById('droughtStats');
            const barEl = document.getElementById('mainBar');
            const statusEl = document.getElementById('apiStatus');
            const dateEl = document.getElementById('dateLabel');

            if (data && data.live) {
                statusEl.textContent = '‚óè Live Data';
                statusEl.className = 'api-status live';
                if (data.date) {
                    const d = new Date(data.date);
                    dateEl.textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                }

                const vals = [
                    { cls: 'none', pct: data.none, lbl: 'None' },
                    { cls: 'd0', pct: data.d0, lbl: 'D0 Abnormal' },
                    { cls: 'd1', pct: data.d1, lbl: 'D1 Moderate' },
                    { cls: 'd2', pct: data.d2, lbl: 'D2 Severe' },
                    { cls: 'd3', pct: data.d3, lbl: 'D3 Extreme' },
                    { cls: 'd4', pct: data.d4, lbl: 'D4 Exception.' }
                ];

                statsEl.innerHTML = vals.map(v =>
                    `<div class="d-stat ${v.cls}"><div class="pct">${v.pct.toFixed(1)}%</div><div class="lbl">${v.lbl}</div></div>`
                ).join('');

                barEl.innerHTML = vals.map(v =>
                    v.pct > 0 ? `<div class="seg ${v.cls}" style="width:${v.pct}%">${v.pct >= 5 ? v.pct.toFixed(0) + '%' : ''}</div>` : ''
                ).join('');
            } else {
                statusEl.textContent = '‚óè Offline';
                statusEl.className = 'api-status offline';
                dateEl.textContent = 'View live data below';

                const stateName = allStates.find(s => s[0] === currentState)?.[1] || currentState;
                statsEl.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    <p style="color: var(--dim); margin-bottom: 12px;">Live data temporarily unavailable. View current data on the official site:</p>
                    <a href="https://droughtmonitor.unl.edu/CurrentMap/StateDroughtMonitor.aspx?${currentState}" target="_blank" rel="noopener noreferrer"
                       style="display:inline-block;padding:12px 24px;background:var(--accent);color:#000;border-radius:6px;text-decoration:none;font-weight:600;">
                       View ${stateName} Drought Data ‚Üí
                    </a>
                </div>`;
                barEl.innerHTML = '';
            }
        }

        async function renderCompare() {
            const neighbors = stateNeighbors[currentState] || [];
            const states = [currentState, ...neighbors];
            const grid = document.getElementById('compareGrid');

            grid.innerHTML = states.map(s => `<div class="compare-card" id="compare-${s}"><h4>${allStates.find(x => x[0] === s)?.[1] || s}</h4><div class="mini-bar" id="bar-${s}"><div style="width:100%;background:var(--border);height:100%;font-size:0.7rem;color:var(--dim);display:flex;align-items:center;justify-content:center;">Loading...</div></div><div class="summary" id="sum-${s}"></div></div>`).join('');

            for (const s of states) {
                const data = await fetchDroughtData(s);
                const bar = document.getElementById('bar-' + s);
                const sum = document.getElementById('sum-' + s);

                if (data && data.live) {
                    const segments = [
                        { cls: 'none', pct: data.none },
                        { cls: 'd0', pct: data.d0 },
                        { cls: 'd1', pct: data.d1 },
                        { cls: 'd2', pct: data.d2 },
                        { cls: 'd3', pct: data.d3 },
                        { cls: 'd4', pct: data.d4 }
                    ];
                    bar.innerHTML = segments.map(seg =>
                        seg.pct > 0 ? `<div class="seg ${seg.cls}" style="width:${seg.pct}%"></div>` : ''
                    ).join('');
                    const inDrought = (100 - data.none).toFixed(1);
                    sum.textContent = `${inDrought}% in drought`;
                    if (s === currentState) {
                        document.getElementById('compare-' + s).style.border = '1px solid var(--accent)';
                    }
                } else {
                    bar.innerHTML = '<div style="width:100%;height:100%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--dim);">No data</div>';
                    sum.textContent = '';
                }
            }
        }

        async function changeState(abbr) {
            currentState = abbr;
            const stateName = allStates.find(s => s[0] === abbr)?.[1] || abbr;
            document.getElementById('stateTitle').textContent = `üìä ${stateName} Drought Status`;

            const data = await fetchDroughtData(abbr);
            renderStats(data);
            renderCompare();
        }

        function detectMyLocation() {
            const btn = document.querySelector('.detect-btn');
            btn.textContent = '...';
            btn.disabled = true;
            AGSIST_GEO.detectLocation(
                (abbr) => {
                    document.getElementById('stateSelect').value = abbr;
                    changeState(abbr);
                    btn.textContent = '‚úì';
                    setTimeout(() => { btn.textContent = 'üìç Detect'; btn.disabled = false; }, 1500);
                },
                () => { btn.textContent = 'üìç Detect'; btn.disabled = false; }
            );
        }

        async function init() {
            populateStates();
            currentState = AGSIST_GEO.getState();
            document.getElementById('stateSelect').value = currentState;
            document.getElementById('stateSelect').addEventListener('change', function() {
                AGSIST_GEO.setState(this.value);
                changeState(this.value);
            });
            await changeState(currentState);
        }

        init();
    </script>
</body>
</html>
